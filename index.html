<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MATRIX TERMINAL</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap');

  * { margin: 0; padding: 0; box-sizing: border-box; }

  :root {
    --green: #00aaff;
    --green-dim: #0088cc;
    --green-dark: #001a33;
    --bg: #0a0a0a;
  }

  body {
    background: radial-gradient(ellipse at center, #0d1520 0%, #050a12 50%, #000000 100%);
    color: var(--green);
    font-family: 'Share Tech Mono', 'Courier New', monospace;
    height: 100vh;
    overflow: hidden;
  }

  /* Matrix rain canvas */
  #matrix-rain {
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    z-index: 0;
    opacity: 0.3;
    pointer-events: none;
  }

  /* CRT scanline overlay */
  .crt-overlay {
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    z-index: 3;
    pointer-events: none;
    background: repeating-linear-gradient(
      0deg,
      rgba(0, 0, 0, 0.15) 0px,
      rgba(0, 0, 0, 0.15) 1px,
      transparent 1px,
      transparent 3px
    );
  }

  .crt-overlay::after {
    content: '';
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: radial-gradient(ellipse at center, transparent 60%, rgba(0,0,0,0.4) 100%);
    pointer-events: none;
  }

  /* Flicker animation */
  @keyframes flicker {
    0%, 97%, 100% { opacity: 1; }
    98% { opacity: 0.95; }
    99% { opacity: 0.98; }
  }

  /* Terminal container */
  .terminal {
    position: relative;
    z-index: 2;
    display: flex;
    flex-direction: column;
    height: 100vh;
    padding: 16px;
    animation: flicker 4s infinite;
  }

  /* Header */
  .terminal-header {
    border-bottom: 1px solid var(--green-dark);
    padding-bottom: 8px;
    margin-bottom: 8px;
    font-size: 13px;
    color: var(--green-dim);
    display: flex;
    justify-content: space-between;
    flex-shrink: 0;
  }

  /* Messages area */
  .messages {
    flex: 1;
    overflow-y: auto;
    padding: 8px 0;
    scrollbar-width: thin;
    scrollbar-color: var(--green-dark) transparent;
  }

  .messages::-webkit-scrollbar { width: 6px; }
  .messages::-webkit-scrollbar-track { background: transparent; }
  .messages::-webkit-scrollbar-thumb { background: var(--green-dark); border-radius: 3px; }

  .message {
    margin-bottom: 10px;
    line-height: 1.5;
    font-size: 14px;
    word-wrap: break-word;
    white-space: pre-wrap;
  }

  .message.user .prefix { color: var(--green); }
  .message.bot .prefix { color: var(--green-dim); }

  .message.bot .text {
    color: var(--green-dim);
  }

  .message.system {
    color: var(--green-dark);
    font-size: 12px;
  }

  .message.error .text {
    color: #ff3333;
    text-shadow: 0 0 6px rgba(255, 50, 50, 0.5);
  }

  .glow {
    text-shadow: 0 0 8px rgba(0, 170, 255, 0.4);
  }

  /* Typing indicator */
  .typing-indicator {
    color: var(--green-dark);
    font-size: 13px;
    margin-bottom: 10px;
  }

  @keyframes blink-dots {
    0%, 20% { content: '.'; }
    40% { content: '..'; }
    60%, 100% { content: '...'; }
  }

  .typing-indicator .dots::after {
    content: '';
    animation: dots 1.5s steps(3) infinite;
  }

  @keyframes dots {
    0% { content: '.'; }
    33% { content: '..'; }
    66% { content: '...'; }
  }

  /* Input area */
  .input-area {
    border-top: 1px solid var(--green-dark);
    padding-top: 12px;
    flex-shrink: 0;
    display: flex;
    align-items: center;
    gap: 8px;
    position: relative;
    z-index: 4;
  }

  .input-prompt {
    color: var(--green);
    font-size: 14px;
    flex-shrink: 0;
  }

  #user-input {
    flex: 1;
    background: transparent;
    border: none;
    outline: none;
    color: var(--green);
    font-family: inherit;
    font-size: 14px;
    caret-color: var(--green);
  }

  #user-input::placeholder {
    color: var(--green-dark);
  }

  #user-input:disabled {
    opacity: 0.5;
  }

  #send-btn {
    background: transparent;
    border: 1px solid var(--green-dark);
    color: var(--green);
    font-family: inherit;
    font-size: 13px;
    padding: 4px 14px;
    cursor: pointer;
    flex-shrink: 0;
    transition: all 0.2s;
    text-transform: uppercase;
    letter-spacing: 1px;
    touch-action: manipulation;
  }

  #send-btn:hover {
    background: var(--green-dark);
    border-color: var(--green);
    text-shadow: 0 0 8px rgba(0, 170, 255, 0.6);
  }

  #send-btn:active {
    background: var(--green);
    color: var(--bg);
  }

  #send-btn:disabled {
    opacity: 0.3;
    cursor: not-allowed;
  }

  @keyframes cursor-blink {
    0%, 50% { opacity: 1; }
    51%, 100% { opacity: 0; }
  }

  .cursor {
    display: inline-block;
    width: 8px;
    height: 16px;
    background: var(--green);
    animation: cursor-blink 1s step-end infinite;
    flex-shrink: 0;
  }

  /* Typewriter animation helper */
  @keyframes type-char {
    from { opacity: 0; }
    to { opacity: 1; }
  }

  /* Mobile */
  @media (max-width: 600px) {
    .terminal { padding: 10px; }
    .message { font-size: 13px; }
    .terminal-header { font-size: 11px; }
    #send-btn { padding: 6px 16px; font-size: 14px; }
    #user-input { font-size: 16px; } /* prevents iOS zoom on focus */
  }

  /* Fix for mobile browsers where 100vh includes the address bar */
  @supports (height: 100dvh) {
    body, .terminal { height: 100dvh; }
  }
</style>
</head>
<body>

<canvas id="matrix-rain"></canvas>
<div class="crt-overlay"></div>

<div class="terminal">
  <div class="terminal-header">
    <span>MATRIX TERMINAL v2.052</span>
    <span id="session-id"></span>
  </div>
  <div class="messages" id="messages"></div>
  <form class="input-area" id="input-form" action="javascript:void(0)">
    <span class="input-prompt">&gt;</span>
    <input type="text" id="user-input" placeholder="enter message..." autocomplete="off" autofocus>
    <button type="submit" id="send-btn">ENTER</button>
    <span class="cursor"></span>
  </form>
</div>

<script>
// ─── CONFIG ───────────────────────────────────────────────────────────
const WEBHOOK_URL = '/webhook';
const SESSION_ID = typeof crypto.randomUUID === 'function'
  ? crypto.randomUUID()
  : 'xxxx-xxxx-xxxx'.replace(/x/g, () => Math.floor(Math.random() * 16).toString(16));

document.getElementById('session-id').textContent = `SID:${SESSION_ID.slice(0, 8)}`;

// ─── DOM ──────────────────────────────────────────────────────────────
const messagesEl = document.getElementById('messages');
const inputEl = document.getElementById('user-input');
const sendBtn = document.getElementById('send-btn');
let isWaiting = false;

// ─── MATRIX RAIN ──────────────────────────────────────────────────────
(function initRain() {
  const canvas = document.getElementById('matrix-rain');
  const ctx = canvas.getContext('2d');

  function resize() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
  }
  resize();
  window.addEventListener('resize', resize);

  const chars = 'アイウエオカキクケコサシスセソタチツテトナニヌネノハヒフヘホマミムメモヤユヨラリルレロワヲン0123456789ABCDEF';
  const fontSize = 14;
  const columns = Math.floor(canvas.width / fontSize);
  const drops = Array(columns).fill(1);

  function draw() {
    ctx.fillStyle = 'rgba(0, 5, 15, 0.06)';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    ctx.font = `${fontSize}px monospace`;

    for (let i = 0; i < drops.length; i++) {
      const char = chars[Math.floor(Math.random() * chars.length)];
      // Bright head of the drop
      ctx.fillStyle = '#aaccff';
      ctx.shadowColor = '#00aaff';
      ctx.shadowBlur = 10;
      ctx.fillText(char, i * fontSize, drops[i] * fontSize);
      // Dimmer trail character just above
      ctx.shadowBlur = 0;
      ctx.fillStyle = '#00aaff';
      const trailChar = chars[Math.floor(Math.random() * chars.length)];
      ctx.fillText(trailChar, i * fontSize, (drops[i] - 1) * fontSize);

      if (drops[i] * fontSize > canvas.height && Math.random() > 0.975) {
        drops[i] = 0;
      }
      drops[i]++;
    }
    requestAnimationFrame(draw);
  }
  draw();
})();

// ─── HELPERS ──────────────────────────────────────────────────────────
function scrollToBottom() {
  messagesEl.scrollTop = messagesEl.scrollHeight;
}

function addMessage(text, type = 'system') {
  const div = document.createElement('div');
  div.className = `message ${type}`;

  if (type === 'user') {
    div.innerHTML = `<span class="prefix glow">&gt; </span><span class="text glow">${escapeHtml(text)}</span>`;
  } else if (type === 'bot') {
    div.innerHTML = `<span class="prefix">[SYSTEM] </span><span class="text"></span>`;
    messagesEl.appendChild(div);
    scrollToBottom();
    typeWriter(div.querySelector('.text'), text);
    return;
  } else if (type === 'error') {
    div.innerHTML = `<span class="prefix">[ERROR] </span><span class="text">${escapeHtml(text)}</span>`;
  } else {
    div.textContent = text;
  }

  messagesEl.appendChild(div);
  scrollToBottom();
}

function typeWriter(el, text, i = 0) {
  if (i < text.length) {
    el.textContent += text[i];
    scrollToBottom();
    setTimeout(() => typeWriter(el, text, i + 1), 18 + Math.random() * 22);
  }
}

function showTyping() {
  const div = document.createElement('div');
  div.className = 'typing-indicator';
  div.id = 'typing';
  div.textContent = '> decrypting response';

  let dotCount = 0;
  div._interval = setInterval(() => {
    dotCount = (dotCount + 1) % 4;
    div.textContent = '> decrypting response' + '.'.repeat(dotCount);
  }, 400);

  messagesEl.appendChild(div);
  scrollToBottom();
}

function hideTyping() {
  const el = document.getElementById('typing');
  if (el) {
    clearInterval(el._interval);
    el.remove();
  }
}

function escapeHtml(str) {
  const d = document.createElement('div');
  d.textContent = str;
  return d.innerHTML;
}

// ─── SEND MESSAGE ─────────────────────────────────────────────────────
async function sendMessage(text) {
  if (!text.trim() || isWaiting) return;

  addMessage(text, 'user');
  inputEl.value = '';
  isWaiting = true;
  inputEl.disabled = true;
  sendBtn.disabled = true;
  showTyping();

  try {
    const res = await fetch(WEBHOOK_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ message: text, sessionId: SESSION_ID })
    });

    if (!res.ok) throw new Error(`HTTP ${res.status}`);

    const data = await res.json();
    hideTyping();

    const reply = typeof data === 'string' ? data
      : data.output ?? data.response ?? data.message ?? data.text ?? JSON.stringify(data);
    addMessage(reply, 'bot');
  } catch (err) {
    hideTyping();
    addMessage(`CONNECTION FAILED: ${err.message}. Check webhook configuration.`, 'error');
  } finally {
    isWaiting = false;
    inputEl.disabled = false;
    sendBtn.disabled = false;
    inputEl.focus();
  }
}

// ─── INPUT HANDLER ────────────────────────────────────────────────────

document.getElementById('input-form').addEventListener('submit', (e) => {
  e.preventDefault();
  sendMessage(inputEl.value);
});

// ─── BOOT SEQUENCE ────────────────────────────────────────────────────
(async function boot() {
  const lines = [
    '[BOOT] Initializing MATRIX TERMINAL v2.052...',
    '[BOOT] Loading neural interface drivers......... OK',
    '[BOOT] Establishing encrypted tunnel............ OK',
    '[BOOT] Synchronizing with mainframe............. OK',
    '[BOOT] Decryption protocols engaged............. OK',
    '[BOOT] System ready.',
    '',
    'Welcome to the Matrix. Type your message below.',
    '─'.repeat(50),
  ];

  for (const line of lines) {
    await new Promise(r => setTimeout(r, 180 + Math.random() * 120));
    addMessage(line, 'system');
  }

  inputEl.focus();
})();
</script>

</body>
</html>
